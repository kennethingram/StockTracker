<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StockTracker - Portfolio Management</title>

    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="favicon.svg">

    <!-- Our custom stylesheet -->
    <link rel="stylesheet" href="css/styles.css">
    
    <!-- Google Identity Services (for OAuth login) -->
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    
    <!-- PDF.js library for reading PDFs -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>
        // Configure PDF.js worker
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    </script>
</head>
<body>
    <!-- Main App Container -->
    <div id="app">
        
        <!-- Login Screen (shown when not authenticated) -->
        <div id="login-screen" class="screen active">
            <div class="login-container">
                <div class="login-logo">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 36 36" width="64" height="64" aria-label="StockTracker logo">
                        <rect x="0" y="0" width="36" height="36" rx="7" fill="#0d1117"/>
                        <polygon points="4,29 10,22 17,25 24,13 32,8 32,36 4,36" fill="rgba(20,184,166,0.12)" stroke="none"/>
                        <polyline points="4,29 10,22 17,25 24,13 32,8" fill="none" stroke="#14b8a6" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round"/>
                        <circle cx="32" cy="8" r="2.5" fill="#14b8a6"/>
                        <text x="18" y="34" text-anchor="middle" font-family="'Courier New',monospace" font-size="8" font-weight="700" fill="#14b8a6" letter-spacing="1.5">ST</text>
                    </svg>
                </div>
                <h1 class="login-title">StockTracker</h1>
                <p class="tagline">Your portfolio, your data, your control</p>
                
                <div class="features">
                    <div class="feature">
                        <span class="icon">üîí</span>
                        <span>Secure Google Drive storage</span>
                    </div>
                    <div class="feature">
                        <span class="icon">ü§ñ</span>
                        <span>AI-powered contract parsing</span>
                    </div>
                    <div class="feature">
                        <span class="icon">üìà</span>
                        <span>Multi-broker support</span>
                    </div>
                </div>
                
                <!-- Google Sign-In Button -->
                <button id="google-signin-btn" class="btn-primary">
                    Sign in with Google
                </button>
                
                <p class="privacy-note">
                    üîê Your data stays in your Google Drive. We never store it on our servers.
                </p>
            </div>
        </div>
        
        <!-- Dashboard Screen (shown after login) -->
        <div id="dashboard-screen" class="screen">
            
            <!-- Navigation Bar -->
            <nav class="navbar">
                <div class="nav-brand">
                    <!-- StockTracker Logo -->
                    <svg class="nav-logo" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 36 36" width="36" height="36" aria-label="StockTracker">
                        <rect x="0" y="0" width="36" height="36" rx="7" fill="#0d1117"/>
                        <polygon points="4,29 10,22 17,25 24,13 32,8 32,36 4,36" fill="rgba(20,184,166,0.10)" stroke="none"/>
                        <polyline points="4,29 10,22 17,25 24,13 32,8" fill="none" stroke="#14b8a6" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round"/>
                        <circle cx="32" cy="8" r="2.5" fill="#14b8a6"/>
                        <text x="18" y="34" text-anchor="middle" font-family="'Courier New',monospace" font-size="8" font-weight="700" fill="#14b8a6" letter-spacing="1.5">ST</text>
                    </svg>
                    <span class="nav-brand-name">StockTracker</span>
                </div>
                <div class="nav-menu">
                    <button class="nav-btn active" data-view="overview">Overview</button>
                    <button class="nav-btn" data-view="holdings">Holdings</button>
                    <button class="nav-btn" data-view="transactions">Transactions</button>
                    <button class="nav-btn" data-view="accounts">Accounts</button>
                    <button class="nav-btn" data-view="sync">Import</button>
                    <button class="nav-btn" data-view="help">Help</button>
                </div>
                <div class="nav-actions">
                    <!-- Profile dropdown -->
                    <div class="profile-wrapper" id="profile-wrapper">
                        <button class="profile-avatar-btn" id="profile-avatar-btn" aria-label="Profile menu" aria-expanded="false">
                            <span id="profile-initials">?</span>
                        </button>
                        <div class="profile-dropdown" id="profile-dropdown" role="menu">
                            <div class="profile-dropdown-header">
                                <div class="profile-dropdown-avatar">
                                    <span id="profile-dropdown-initials">?</span>
                                </div>
                                <div class="profile-dropdown-info">
                                    <div class="profile-dropdown-name" id="profile-dropdown-name">User</div>
                                    <div class="profile-dropdown-email" id="profile-dropdown-email"></div>
                                </div>
                            </div>
                            <div class="profile-dropdown-divider"></div>
                            <button class="profile-dropdown-item" onclick="UI.switchView('admin'); UI.closeProfileMenu();">‚öôÔ∏è Admin Settings</button>
                            <div class="profile-dropdown-divider"></div>
                            <button class="profile-dropdown-item profile-dropdown-signout" id="profile-signout-btn">Sign Out</button>
                        </div>
                    </div>
                    <!-- Hamburger (mobile only ‚Äî rightmost) -->
                    <button id="hamburger-btn" class="hamburger-btn" aria-label="Open menu">‚ò∞</button>
                </div>
            </nav>

            <!-- Mobile Sidebar Overlay -->
            <div id="nav-sidebar-overlay" class="nav-sidebar-overlay"></div>

            <!-- Mobile Sidebar Nav -->
            <nav id="nav-sidebar" class="nav-sidebar">
                <div class="nav-sidebar-header">
                    <div class="nav-sidebar-brand">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 36 36" width="28" height="28" aria-hidden="true">
                            <rect x="0" y="0" width="36" height="36" rx="7" fill="#0d1117"/>
                            <polygon points="4,29 10,22 17,25 24,13 32,8 32,36 4,36" fill="rgba(20,184,166,0.10)" stroke="none"/>
                            <polyline points="4,29 10,22 17,25 24,13 32,8" fill="none" stroke="#14b8a6" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round"/>
                            <circle cx="32" cy="8" r="2.5" fill="#14b8a6"/>
                            <text x="18" y="34" text-anchor="middle" font-family="'Courier New',monospace" font-size="8" font-weight="700" fill="#14b8a6" letter-spacing="1.5">ST</text>
                        </svg>
                        <span>StockTracker</span>
                    </div>
                    <button id="sidebar-close-btn" class="sidebar-close-btn">‚úï</button>
                </div>
                <div class="nav-sidebar-links">
                    <button class="nav-sidebar-btn active" data-view="overview">üìä Overview</button>
                    <button class="nav-sidebar-btn" data-view="holdings">üì¶ Holdings</button>
                    <button class="nav-sidebar-btn" data-view="transactions">üìã Transactions</button>
                    <button class="nav-sidebar-btn" data-view="accounts">üè¶ Accounts</button>
                    <button class="nav-sidebar-btn" data-view="sync">üîÑ Import</button>
                    <button class="nav-sidebar-btn" data-view="help">‚ùì Help</button>
                </div>
                <div class="nav-sidebar-footer">
                    <span id="sidebar-user-email" class="sidebar-email"></span>
                    <button class="btn-secondary" id="sidebar-signout-btn">Sign Out</button>
                </div>
            </nav>
            
            <!-- Main Content Area -->
            <main class="content">
                
                <!-- Overview View -->
                <div id="overview-view" class="view active">
                    <div class="view-header">
                        <h1>Portfolio Overview
                            <button class="icon-action-btn" onclick="UI.refreshAllPrices()" title="Click to fetch latest prices and FX rates" aria-label="Refresh prices and FX rates">
                                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <polyline points="23 4 23 10 17 10"></polyline>
                                    <polyline points="1 20 1 14 7 14"></polyline>
                                    <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path>
                                </svg>
                            </button>
                        </h1>
                    </div>
                    <!-- Hidden status elements (updated by JS) -->
                    <span id="price-update-status" class="price-status-inline"></span>
                    <span id="price-cache-info" style="display:none"></span>

                    <!-- Filter Bar -->
                    <div class="filter-bar">
                        <div class="filter-trigger-wrap" id="overview-filter-wrap">
                            <button class="filter-trigger-btn" id="overview-filter-btn" onclick="UI.toggleFilterPopover('overview')">
                                Filters <span class="filter-badge" id="overview-filter-badge"></span>
                            </button>
                            <div class="filter-popover" id="overview-filter-popover">
                                <div class="filter-pop-group">
                                    <div class="filter-pop-label">Accounts</div>
                                    <div id="overview-fp-accounts"></div>
                                </div>
                                <div class="filter-pop-sep"></div>
                                <div class="filter-pop-group">
                                    <div class="filter-pop-label">Holders</div>
                                    <div id="overview-fp-holders"></div>
                                </div>
                                <div class="filter-pop-footer">
                                    <button class="filter-pop-clear" onclick="UI.clearFilters('overview')">Clear all</button>
                                    <button class="filter-pop-save" onclick="UI.showSaveFavoriteModal('overview')">Save view ‚òÖ</button>
                                </div>
                            </div>
                        </div>
                        <div class="filter-chips" id="overview-filter-chips"></div>
                        <div class="filter-bar-spacer"></div>
                        <select class="filter-currency-select" id="overview-currency-select" onchange="UI.changeOverviewCurrency(this.value)">
                            <option value="CAD">CAD</option>
                            <option value="USD">USD</option>
                            <option value="GBP">GBP</option>
                            <option value="EUR">EUR</option>
                            <option value="AUD">AUD</option>
                            <option value="CHF">CHF</option>
                        </select>
                    </div>

                    <!-- Favorites Bar -->
                    <div id="overview-favorites-bar" class="favorites-bar"></div>

                    <!-- Overview Cards -->

                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-label">Total Portfolio Value</div>
                            <div class="stat-value" id="total-value">$0.00</div>
                            <div class="stat-subvalue" id="value-currency">CAD</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">Total Invested</div>
                            <div class="stat-value" id="total-invested">$0.00</div>
                            <div class="stat-subvalue" id="invested-currency">CAD</div>
                        </div>
                        <div class="stat-card stat-card-highlight">
                            <div class="stat-label">Total Profit/Loss</div>
                            <div class="stat-value" id="total-pl">$0.00</div>
                            <div class="stat-subvalue" id="total-pl-percent">0.0%</div>
                        </div>
                        <div class="stat-card stat-card-highlight">
                            <div class="stat-label">Annualized Return (ARR)</div>
                            <div class="stat-value" id="total-arr">0.0%</div>
                            <div class="stat-subvalue" id="arr-subtext">Portfolio weighted</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">Total Positions</div>
                            <div class="stat-value" id="total-positions">0</div>
                            <div class="stat-subvalue">Holdings</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">Accounts</div>
                            <div class="stat-value" id="total-accounts">0</div>
                            <div class="stat-subvalue">Active accounts</div>
                        </div>
                    </div>

                    <div class="recent-transactions">
                        <h2>Holdings Summary</h2>
                        <div id="recent-transactions-list">
                            <p class="empty-state">No holdings yet. Click "Sync" to process contract notes.</p>
                        </div>
                    </div>
                </div>
                
                <!-- Holdings View -->
                <div id="holdings-view" class="view">
                    <h1>Current Holdings</h1>

                    <!-- Filter Bar -->
                    <div class="filter-bar">
                        <div class="filter-trigger-wrap" id="holdings-filter-wrap">
                            <button class="filter-trigger-btn" id="holdings-filter-btn" onclick="UI.toggleFilterPopover('holdings')">
                                Filters <span class="filter-badge" id="holdings-filter-badge"></span>
                            </button>
                            <div class="filter-popover" id="holdings-filter-popover">
                                <div class="filter-pop-group">
                                    <div class="filter-pop-label">Accounts</div>
                                    <div id="holdings-fp-accounts"></div>
                                </div>
                                <div class="filter-pop-sep"></div>
                                <div class="filter-pop-group">
                                    <div class="filter-pop-label">Holders</div>
                                    <div id="holdings-fp-holders"></div>
                                </div>
                                <div class="filter-pop-footer">
                                    <button class="filter-pop-clear" onclick="UI.clearFilters('holdings')">Clear all</button>
                                    <button class="filter-pop-save" onclick="UI.showSaveFavoriteModal('holdings')">Save view ‚òÖ</button>
                                </div>
                            </div>
                        </div>
                        <div class="filter-chips" id="holdings-filter-chips"></div>
                        <div class="filter-bar-spacer"></div>
                        <select class="filter-currency-select" id="holdings-currency-select" onchange="UI.changeHoldingsCurrency(this.value)">
                            <option value="CAD">CAD</option>
                            <option value="USD">USD</option>
                            <option value="GBP">GBP</option>
                            <option value="EUR">EUR</option>
                            <option value="AUD">AUD</option>
                            <option value="CHF">CHF</option>
                        </select>
                    </div>

                    <!-- Favorites Bar -->
                    <div id="holdings-favorites-bar" class="favorites-bar"></div>
                    
                    <div id="holdings-list">
                        <p class="empty-state">No holdings yet.</p>
                    </div>
                </div>
                
                <!-- Transactions View -->
                <div id="transactions-view" class="view">
                    <div class="view-header">
                        <h1>All Transactions
                            <button class="icon-action-btn" onclick="UI.exportTransactionsCSV()" title="Export CSV" aria-label="Export CSV">
                                <svg xmlns="http://www.w3.org/2000/svg" width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round">
                                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                                    <polyline points="7 10 12 15 17 10"></polyline>
                                    <line x1="12" y1="15" x2="12" y2="3"></line>
                                </svg>
                            </button>
                        </h1>
                    </div>

                    <!-- Filter Bar -->
                    <div class="filter-bar">
                        <div class="filter-trigger-wrap" id="transactions-filter-wrap">
                            <button class="filter-trigger-btn" id="transactions-filter-btn" onclick="UI.toggleFilterPopover('transactions')">
                                Filters <span class="filter-badge" id="transactions-filter-badge"></span>
                            </button>
                            <div class="filter-popover" id="transactions-filter-popover">
                                <div class="filter-pop-group">
                                    <div class="filter-pop-label">Accounts</div>
                                    <div id="transactions-fp-accounts"></div>
                                </div>
                                <div class="filter-pop-sep"></div>
                                <div class="filter-pop-group">
                                    <div class="filter-pop-label">Holders</div>
                                    <div id="transactions-fp-holders"></div>
                                </div>
                                <div class="filter-pop-footer">
                                    <button class="filter-pop-clear" onclick="UI.clearFilters('transactions')">Clear all</button>
                                    <button class="filter-pop-save" onclick="UI.showSaveFavoriteModal('transactions')">Save view ‚òÖ</button>
                                </div>
                            </div>
                        </div>
                        <div class="filter-chips" id="transactions-filter-chips"></div>
                    </div>

                    <!-- Favorites Bar -->
                    <div id="transactions-favorites-bar" class="favorites-bar"></div>
                    
                    <div id="transactions-list">
                        <p class="empty-state">No transactions yet.</p>
                    </div>
                </div>
                
                <!-- Sync / Import View -->
                <div id="sync-view" class="view">
                    <h1>Import Contract Notes</h1>

                    <div class="sync-actions">
                        <button id="scan-new-files-btn" class="btn-primary">
                            üîç Scan for New Contract Notes
                        </button>
                        <button id="process-all-btn" class="btn-secondary">
                            ‚ö° Process All Unprocessed Files
                        </button>
                    </div>
                    
                    <div id="new-files-list" class="files-list">
                        <!-- New files will be listed here -->
                    </div>
                </div>
                <!-- Accounts View -->
                <div id="accounts-view" class="view">
                    <h1>Account Management</h1>
                    
                    <div class="account-actions">
                        <button id="add-account-btn" class="btn-primary">
                            ‚ûï Add New Account
                        </button>
                    </div>
                    
                    <div id="accounts-list" class="accounts-list">
                        <p class="empty-state">No accounts yet. Click "Add New Account" to create one.</p>
                    </div>
                    
                    <!-- Account Form Modal (hidden by default) -->
                    <div id="account-modal" class="modal">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h2 id="modal-title">Add New Account</h2>
                                <button class="modal-close" id="close-modal-btn">&times;</button>
                            </div>
                            <div class="modal-body">
                                <form id="account-form">
                                    <div class="form-group">
                                        <label for="account-name">Account Name *</label>
                                        <input type="text" id="account-name" required placeholder="e.g., Schwab Trading Account">
                                    </div>
                                    
                                    <div class="form-group">
                                        <label for="account-number">Account Number *</label>
                                        <input type="text" id="account-number" required placeholder="e.g., XXXX-12345">
                                    </div>
                                    
                                    <div class="form-group">
                                        <label for="broker-name">Broker</label>
                                        <input type="text" id="broker-name" placeholder="e.g., Charles Schwab">
                                    </div>

                                     <div class="form-group">
                                        <label for="account-holders">Account Holders *</label>
                                        <input type="text" id="account-holders" required placeholder="e.g., Kenneth Ingram, Mathangi Ingram">
                                        <small>
                                            Separate multiple holders with commas
                                        </small>
                                    </div>

                                    <div class="form-group">
                                        <label for="account-type">Account Type *</label>
                                        <select id="account-type" required>
                                            <option value="">Select type...</option>
                                        </select>
                                    </div>
                                    
                                    <div class="form-group">
                                        <label for="account-currency">Default Currency *</label>
                                        <select id="account-currency" required>
                                            <option value="">Select currency...</option>
                                        </select>
                                    </div>
                                    
                                    <div class="form-group">
                                        <label for="account-notes">Notes</label>
                                        <textarea id="account-notes" rows="3" placeholder="Optional notes about this account"></textarea>
                                    </div>
                                    
                                    <div class="form-actions">
                                        <button type="button" class="btn-secondary" id="cancel-account-btn">Cancel</button>
                                        <button type="submit" class="btn-primary">Save Account</button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- Admin View -->
                <div id="admin-view" class="view">
                    <h1>Administration</h1>

                    <div class="admin-section">
                        <h2>Contract Notes Folder</h2>
                        <p>Google Drive folder for contract notes: <strong id="admin-folder-name">Loading‚Ä¶</strong></p>
                        <button id="admin-select-folder-btn" class="btn-secondary">Change Folder</button>
                    </div>

                    <div class="admin-section">
                        <h2>Reporting Currency</h2>
                        <p>All portfolio totals are converted to this currency.</p>
                        <div style="display:flex; gap:10px; align-items:center; margin-top:8px;">
                            <select id="admin-base-currency" style="flex:1; max-width:280px;">
                                <!-- Populated by JS from CONFIG.supportedCurrencies -->
                            </select>
                            <button class="btn-primary" onclick="UI.saveBaseCurrency()">Save</button>
                        </div>
                    </div>

                    <div class="admin-section">
                        <h2>Price Data</h2>
                        <p>Alpha Vantage API calls today: <strong id="admin-av-calls">‚Äî</strong> / 25</p>
                        <div style="display:flex; gap:10px; margin-top:8px; flex-wrap:wrap;">
                            <button class="btn-secondary" onclick="UI.clearPriceCache()">Clear Price Cache</button>
                            <button class="btn-secondary" onclick="UI.backfillMissingFXRates()" title="Fetch and store historical FX rates for any transaction that is missing them">Fix Missing FX Rates</button>
                        </div>
                    </div>

                    <div class="admin-section">
                        <h2>Export Data</h2>
                        <p>Download a full backup of your transactions and accounts.</p>
                        <div style="display:flex; gap:10px; margin-top:8px;">
                            <button class="btn-secondary" onclick="UI.exportDatabaseJSON()">‚¨á Download JSON Backup</button>
                        </div>
                    </div>

                    <div class="admin-section admin-danger">
                        <h2>Danger Zone</h2>
                        <p>Permanently delete all transactions, accounts and settings. This cannot be undone.</p>
                        <button class="btn-danger" style="margin-top:8px;" onclick="UI.clearAllData()">Clear All Data</button>
                    </div>
                </div>

                <!-- Help View -->
                <div id="help-view" class="view">
                    <h1>Help</h1>

                    <div class="help-section">
                        <h2>About StockTracker</h2>
                        <p>StockTracker is a private, browser-based portfolio tracker. It connects to your own Google Drive to store data ‚Äî nothing is saved on external servers. Use it to track stock purchases across multiple brokers and currencies, and see real-time portfolio performance.</p>

                        <h3>Key Features</h3>
                        <ul>
                            <li><strong>AI Contract Parsing</strong> ‚Äî Upload PDF contract notes to Google Drive; the app uses Gemini Vision to extract transactions automatically.</li>
                            <li><strong>Multi-Currency</strong> ‚Äî Supports CAD, USD, GBP, EUR, AUD, CHF. Historical FX rates are locked in at transaction date; live rates update your current value.</li>
                            <li><strong>Live Prices</strong> ‚Äî Finnhub (US/CA) and Alpha Vantage (UK/LSE) provide real-time quotes. Click the refresh icon on Overview to update.</li>
                            <li><strong>Analytics</strong> ‚Äî P/L, ARR (Annualised Return Rate), ACB (Adjusted Cost Base), and total value calculated per holding and across the portfolio.</li>
                            <li><strong>Filters</strong> ‚Äî Filter by account or account holder across Overview, Holdings, and Transactions. Filters are shared across tabs and can be saved as favourites.</li>
                        </ul>

                        <h3>Getting Started</h3>
                        <ol>
                            <li>Sign in with your Google account.</li>
                            <li>Go to <strong>Accounts</strong> and create at least one brokerage account.</li>
                            <li>Go to <strong>Admin</strong> ‚Üí set your Contract Notes folder in Google Drive.</li>
                            <li>Upload a PDF contract note to that folder.</li>
                            <li>Go to <strong>Import</strong> ‚Äî the app auto-scans and shows unprocessed files. Click <em>Process</em>.</li>
                            <li>Review the extracted transactions, correct any fields, and click <em>Accept</em>.</li>
                            <li>Return to <strong>Overview</strong> and click the refresh icon to load live prices.</li>
                        </ol>

                        <h3>Tips</h3>
                        <ul>
                            <li>Use the <strong>Currency</strong> filter on Overview and Holdings to view your portfolio in any supported currency.</li>
                            <li>The <strong>ACB</strong> (Adjusted Cost Base) column reflects your average cost per share based on the filtered view.</li>
                            <li>Free API limits apply ‚Äî Finnhub: 60 calls/min; Alpha Vantage: 25 calls/day. Prices fall back to last known values when limits are hit.</li>
                            <li>Export transactions as CSV from the Transactions page (download icon next to the title).</li>
                            <li>Download a full JSON backup from the <strong>Admin</strong> page at any time.</li>
                        </ul>
                    </div>

                    <div class="help-section">
                        <h2>Privacy Statement</h2>

                        <h3>What data is used</h3>
                        <p>StockTracker accesses your Google account name and email (to display your profile), and your Google Drive (to store and retrieve your portfolio database file). No other Google data is accessed.</p>
                        <p>Stock price data is fetched from Finnhub and Alpha Vantage via a secure server-side proxy. Your portfolio data is <strong>never</strong> sent to these services ‚Äî only the ticker symbols you hold are used in API calls.</p>
                        <p>Currency exchange rates are fetched from frankfurter.app (European Central Bank). No account data is involved in these calls.</p>

                        <h3>Where data is stored</h3>
                        <p>All your portfolio data (transactions, accounts, settings) is stored in a single JSON file inside <strong>your own Google Drive</strong>, at <code>/StockTracker/stocktracker-transactions.json</code>. You own this file and can delete it at any time.</p>
                        <p>Your browser's <code>localStorage</code> stores your session token, display preferences (currency, initials), and cached stock prices. This data stays on your device and is cleared when you sign out.</p>

                        <h3>How data moves</h3>
                        <p>All communication uses HTTPS. API calls to Gemini, Finnhub, and Alpha Vantage are routed through a Cloudflare Pages Function ‚Äî the API keys never leave the server. Your portfolio JSON travels only between your browser and your own Google Drive.</p>
                        <p>There is no analytics, no tracking, and no data collection by StockTracker or any third party beyond the services listed above.</p>
                    </div>
                </div>

            </main>
        </div>

        <!-- Loading Overlay (shown during operations) -->
        <div id="loading-overlay" class="loading-overlay">
            <div class="spinner"></div>
            <p id="loading-message">Loading...</p>
        </div>
        
        <!-- Favorite Save Modal (hidden by default) -->
        <div id="favorite-modal" class="modal">
            <div class="modal-content" style="max-width: 500px;">
                <div class="modal-header">
                    <h2>Save Current View as Favorite</h2>
                    <button class="modal-close" onclick="UI.hideFavoriteModal()">&times;</button>
                </div>
                <div class="modal-body">
                    <form id="favorite-form" onsubmit="event.preventDefault(); UI.saveFavorite();">
                        <div class="form-group">
                            <label for="favorite-name">Favorite Name *</label>
                            <input type="text" id="favorite-name" required placeholder="e.g., My TFSA Accounts">
                        </div>
                        
                        <div id="favorite-summary">
                            <strong style="font-size: 0.82em; color: var(--text-secondary);">Current Filters:</strong>
                            <div id="favorite-summary-content">
                                <!-- Populated by JS -->
                            </div>
                        </div>
                        
                        <div class="form-actions">
                            <button type="button" class="btn-secondary" onclick="UI.hideFavoriteModal()">Cancel</button>
                            <button type="submit" class="btn-primary">üíæ Save Favorite</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>


    <!-- Edit Transaction Modal -->
    <div id="edit-transaction-modal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h2>Edit Transaction</h2>
                <button class="modal-close" onclick="UI.hideEditTransactionModal()">&times;</button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="edit-txn-id">

                <div class="form-group">
                    <label for="edit-txn-date">Date</label>
                    <input type="date" id="edit-txn-date" required>
                </div>

                <div class="form-group">
                    <label for="edit-txn-symbol">Symbol</label>
                    <input type="text" id="edit-txn-symbol" required placeholder="e.g., AAPL">
                </div>

                <div class="form-group">
                    <label for="edit-txn-company">Company Name</label>
                    <input type="text" id="edit-txn-company" placeholder="e.g., Apple Inc.">
                </div>

                <div class="form-group">
                    <label for="edit-txn-exchange">Exchange</label>
                    <input type="text" id="edit-txn-exchange" placeholder="e.g., NYSE, TSX, LSE, NASDAQ">
                </div>

                <div class="form-group">
                    <label for="edit-txn-type">Type</label>
                    <select id="edit-txn-type" required>
                        <option value="buy">BUY</option>
                        <option value="sell">SELL</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="edit-txn-quantity">Quantity</label>
                    <input type="number" id="edit-txn-quantity" required min="0" step="any" placeholder="0">
                </div>

                <div class="form-group">
                    <label for="edit-txn-currency">Currency</label>
                    <select id="edit-txn-currency" required>
                        <!-- Populated by JS from CONFIG.supportedCurrencies -->
                    </select>
                </div>

                <div class="form-group">
                    <label for="edit-txn-price">Price per Share</label>
                    <input type="number" id="edit-txn-price" required min="0" step="any" placeholder="0.00">
                </div>

                <div class="form-group">
                    <label for="edit-txn-fees">Fees</label>
                    <input type="number" id="edit-txn-fees" min="0" step="any" placeholder="0.00">
                </div>

                <div class="form-group">
                    <label for="edit-txn-total">Total</label>
                    <input type="number" id="edit-txn-total" min="0" step="any" placeholder="0.00">
                </div>

                <div class="form-group">
                    <label for="edit-txn-account">Account</label>
                    <select id="edit-txn-account" onchange="UI.onEditAccountChange()">
                        <option value="">‚Äî No account ‚Äî</option>
                        <!-- Populated by JS from Database accounts -->
                    </select>
                </div>

                <div class="form-group">
                    <label>Account Number</label>
                    <input type="text" id="edit-txn-account-number" readonly class="input-readonly" placeholder="Auto-populated from account">
                </div>

                <div class="form-group">
                    <label>Broker</label>
                    <input type="text" id="edit-txn-broker" readonly class="input-readonly" placeholder="Auto-populated from account">
                </div>

                <div class="form-actions edit-txn-actions">
                    <button type="button" class="btn-danger" id="edit-txn-delete-btn">Delete Transaction</button>
                    <div class="edit-txn-confirm-actions">
                        <button type="button" class="btn-secondary" onclick="UI.hideEditTransactionModal()">Cancel</button>
                        <button type="button" class="btn-primary" onclick="UI.saveEditedTransaction()">Save Changes</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    </div>

    <!-- Load configuration first -->
    <script src="config.js"></script>
    <!-- Load local dev keys if present (gitignored, silently skipped in production) -->
    <script src="config.local.js" onerror="null"></script>
    
    <!-- Load all modules -->
    <script src="modules/auth.js"></script>
    <script src="modules/drive.js"></script>
    <script src="modules/database.js"></script>
    <script src="modules/fx.js"></script>
    <script src="modules/prices.js"></script>
    <script src="modules/parser.js"></script>
    <script src="modules/portfolio.js"></script>
    <script src="modules/ui.js"></script>
    
    <!-- Initialize the app -->
    <script>
        // This runs when the page loads
        document.addEventListener('DOMContentLoaded', function() {
            console.log('StockTracker initializing...');
            
            // Initialize UI module
            if (typeof UI !== 'undefined') {
                UI.init();
            }
        });
    </script>
</body>
</html>